---
// ViewCounter component for tracking and displaying page views
interface Props {
	slug: string;
}

const { slug } = Astro.props;
---

<div class="view-counter" data-slug={slug}>
	<span class="view-icon">üëÅÔ∏è</span>
	<span class="view-count">-</span>
	<span class="view-text">views</span>
</div>

<script>
	// This script runs on the client side to fetch and update view counts
	document.addEventListener('DOMContentLoaded', async () => {
		const counter = document.querySelector('.view-counter');
		if (!counter) return;

		const slug = counter.getAttribute('data-slug');
		if (!slug) return;

		const countSpan = counter.querySelector('.view-count');
		if (!countSpan) return;

		try {
			// First, increment the view count
			const incrementResponse = await fetch(`/api/views?slug=${encodeURIComponent(slug)}`, {
				method: 'POST'
			});

			if (incrementResponse.ok) {
				const data = await incrementResponse.json();
				countSpan.textContent = data.views.toLocaleString();
			} else {
				// If increment fails, try to get current count
				const getResponse = await fetch(`/api/views?slug=${encodeURIComponent(slug)}`);
				if (getResponse.ok) {
					const data = await getResponse.json();
					countSpan.textContent = data.views.toLocaleString();
				} else {
					countSpan.textContent = 'N/A';
				}
			}
		} catch (error) {
			console.error('Failed to update view count:', error);
			countSpan.textContent = 'N/A';
		}
	});
</script>

<style>
	.view-counter {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		color: rgb(var(--gray));
		font-size: 0.9rem;
		padding: 0.25rem 0;
	}

	.view-icon {
		font-size: 1rem;
	}

	.view-count {
		font-weight: 600;
		color: rgb(var(--gray-dark));
	}

	.view-text {
		color: rgb(var(--gray));
	}
</style>
